server {
    root /var/www/hesen;
    index index.html;
    server_name web.7esentv.com;

    # üöÄ Gzip compression for faster loading
    gzip on;
    gzip_types text/plain text/css application/javascript application/json application/wasm application/octet-stream;
    gzip_min_length 1000;
    gzip_comp_level 6;

    # üìÅ Final MIME type handling
    include /etc/nginx/mime.types;
    types {
        application/javascript mjs; # 'js' is already in mime.types, adding it here causes warnings
        application/wasm wasm;
    }
    default_type application/octet-stream;

    # üõ°Ô∏è Security Headers for Flutter WASM (skwasm)
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Access-Control-Allow-Origin "*" always;

    # ‚úÖ Static assets with caching
    location ~* \.(png|jpg|jpeg|gif|ico|json|js|mjs|css|otf|ttf|woff|woff2|wasm)$ {
        expires 1y;
        add_header Cache-Control "public, no-transform";
        try_files $uri =404;
    }

    # üö´ No-cache for bootstrap and logic files
    location ~* (index\.html|flutter_bootstrap\.js|flutter_service_worker\.js|version\.json|main\.dart\.mjs|main\.dart\.wasm|canvaskit\.js|skwasm\.js)$ {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        try_files $uri =404;
    }

    location / {
        try_files $uri $uri/ /index.html;
    }

    # üî• Backend API Reverse Proxy ‚Äî eliminates CORS completely
    # Requests to /api/mobile/... are forwarded to Vercel backend
    location /api/ {
        # Fix for Flutter http package: force Content-Length instead of chunked
        gzip off;
        chunked_transfer_encoding off;
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        proxy_set_header Accept-Encoding "";
        
        resolver 8.8.8.8;
        proxy_pass https://7esentvbackend.vercel.app/api/;
        proxy_set_header Host 7esentvbackend.vercel.app;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        proxy_http_version 1.1;
    }

    # üåê Generic Stream Proxy (To solve Mixed Content: HTTPS Site -> HTTP Stream)
    # Usage: https://web.7esentv.com/proxy?url=http://example.com/stream.m3u8
    location /proxy {
        resolver 8.8.8.8; # Google DNS for resolving upstream domains
        gzip off;
        proxy_set_header Accept-Encoding "";
        
        # üõ°Ô∏è Extract Host from URL for Vercel/Cloudflare compatibility
        set $target_host "";
        if ($arg_url ~* ^https?://([^/:]+)) {
            set $target_host $1;
        }

        proxy_pass $arg_url;
        proxy_set_header Host $target_host;
        proxy_set_header User-Agent "VLC/3.0.18 LibVLC/3.0.18"; # Avoid blocking
        proxy_ssl_server_name on;

        # üîë Rewrite HTTP redirect Location headers to go through our HTTPS proxy
        # When IPTV servers return 302 redirect to HTTP URL, rewrite it so
        # the browser follows the redirect through our proxy (staying on HTTPS)
        proxy_redirect ~^(http://.+)$ https://hi.husseinh2711.workers.dev/?url=$1;
        proxy_redirect ~^(https://.+)$ https://hi.husseinh2711.workers.dev/?url=$1;
        
        # Enable CORS for web player
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Range, Content-Type' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;
        
        # Handle Preflight
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'Range, Content-Type';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        # Stream optimizations
        proxy_buffering off;
        proxy_ignore_client_abort on;
    }

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/web.7esentv.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/web.7esentv.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = web.7esentv.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80 default_server;
    listen [::]:80 default_server;
    server_name web.7esentv.com;
    return 404; # managed by Certbot
}
